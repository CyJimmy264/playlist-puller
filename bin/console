#!/usr/bin/env ruby

require "bundler/setup"

require 'playlist'
require 'playlist/puller'
require 'down'
require 'ruby-progressbar'

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.

# (If you use this, don't forget to add pry to your Gemfile!)
# require "irb"
# IRB.start(__FILE__)

require "pry"

DEST = "/run/media/mveynberg/home/mveynberg/Музыка/VK"

playlist = nil
File.open("tmp/playlist.m3u") do |file|
  playlist = Playlist::Format::M3U.parse(file)
end

vk_playlist = Playlist.new title: "VK"

def sanitize(str)
  str.gsub(/[\%\/\-]/) { |c| '%%%02X' % c.ord }
end

playlist.tracks.each do |track|
  title = sanitize track.title
  artist = sanitize track.contributor_names

  track_name = "#{artist} - #{title}"
  track_filename = "#{track_name}.mp3"
  track_filepath = "#{DEST}/#{track_filename}"


  unless File.file?(track_filepath)
    puts "Down #{track_name}"

    progressbar = ProgressBar.create(format: '%a <%B> %p%% %t')

    begin
    Down.download track.location,
                  destination: track_filepath,
                  content_length_proc: -> (content_length) { progressbar.total = content_length },
                  progress_proc:       -> (progress)       { progressbar.progress = progress }
    rescue
      puts "Failed"
    end
  end
end
